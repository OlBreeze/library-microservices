version: '3.9'

services:
  # ============================================
  # Auth Service (Port 8001)
  # ============================================
  auth_service:
    build:
      context: ./auth_service
      dockerfile: Dockerfile
    container_name: library_auth_service
    ports:
      - "8001:8000"
    environment:
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=${JWT_ALGORITHM}
      - JWT_ACCESS_TOKEN_LIFETIME_HOURS=${JWT_ACCESS_TOKEN_LIFETIME_HOURS}
      - JWT_REFRESH_TOKEN_LIFETIME_DAYS=${JWT_REFRESH_TOKEN_LIFETIME_DAYS}
      - DEBUG=${DEBUG}
      - DB_ENGINE=${DB_ENGINE}
    volumes:
      - ./auth_service:/app
      - auth_static:/app/staticfiles
      - auth_db:/app/db
    networks:
      - library_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/admin/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Books Service (Port 8002)
  # ============================================
  books_service:
    build:
      context: ./books_service
      dockerfile: Dockerfile
    container_name: library_books_service
    ports:
      - "8002:8000"
    environment:
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=${JWT_ALGORITHM}
      - DEBUG=${DEBUG}
      - DB_ENGINE=${DB_ENGINE}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
    volumes:
      - ./books_service:/app
      - books_static:/app/staticfiles
      - books_db:/app/db
    networks:
      - library_network
    depends_on:
      auth_service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/admin/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Nginx (Reverse Proxy) - опціонально
  # ============================================
#  nginx:
#    image: nginx:alpine
#    container_name: library_nginx
#    ports:
#      - "80:80"
#    volumes:
#      - ./nginx.conf:/etc/nginx/nginx.conf:ro
#      - auth_static:/static/auth:ro
#      - books_static:/static/books:ro
#    networks:
#      - library_network
#    depends_on:
#      - auth_service
#      - books_service
#    restart: unless-stopped

# ============================================
# Networks
# ============================================
networks:
  library_network:
    driver: bridge

# ============================================
# Volumes (збереження даних)
# ============================================
volumes:
  auth_static:
  books_static:
  auth_db:
  books_db: